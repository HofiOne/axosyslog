# TODO rewrite rpm and deb packaging for AxoSyslog and remove this job (use "create-packages" instead)
name: AxoSyslog packages
on:
  workflow_call:
    inputs:
      repo:
        description: 'AxoSyslog repository'
        required: true
        default: 'axoflow/axosyslog'
        type: string
      version:
        description: 'AxoSyslog version'
        required: true
        type: string

  workflow_dispatch:
    inputs:
      repo:
        description: 'AxoSyslog repository'
        required: true
        default: 'axoflow/axosyslog'
        type: string
      version:
        description: 'AxoSyslog version'
        required: true
        type: string

jobs:
  create-source-tarball:
    runs-on: ubuntu-latest
    steps:
      - name: Get AxoSyslog tarball
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --repo '${{ inputs.repo }}' -p 'axosyslog-${{ inputs.version }}.tar.gz' 'axosyslog-${{ inputs.version }}'

      - name: Extract source tarball
        run: |
          mkdir axosyslog
          tar --strip-components=1 -xvf axosyslog*.tar.gz -C axosyslog
          rm axosyslog*.tar.gz

      - name: AxoSyslog patches
        working-directory: axosyslog
        run: |
          sed -i 's/Name: syslog-ng/Name: axosyslog/' packaging/rhel/syslog-ng.spec
          sed -i 's|%{name}-%{version}.tar.gz|syslog-ng-%{version}.tar.gz|' packaging/rhel/syslog-ng.spec
          sed -i 's|URL.*|URL: https://axoflow.com/docs/axosyslog-core/|' packaging/rhel/syslog-ng.spec
          sed -i 's|Provides: syslog|&\n\nConflicts: syslog-ng\nConflicts: syslog-ng-premium-edition|' packaging/rhel/syslog-ng.spec
          sed -i 's|%setup -q|%setup -q -n syslog-ng-%{version}|' packaging/rhel/syslog-ng.spec
          sed -i 's|/%{name}|/syslog-ng|g' packaging/rhel/syslog-ng.spec
          sed -i 's|/lib%{name}|/libsyslog-ng|g' packaging/rhel/syslog-ng.spec
          sed -i 's|^.*czanik/syslog-ng-githead.*$||' dbld/builddeps

          # Remove extra dependencies
          sed -i 's|almalinux.*|&,nocriterion,noriemann,nokafka,nomqtt,nojava|' dbld/build.manifest

          cat packaging/rhel/syslog-ng.spec

      - name: Prepare docker image
        working-directory: axosyslog
        run: ./dbld/rules cache-image-tarball

      - name: Create source tarball
        working-directory: axosyslog
        run: ./dbld/rules pkg-tarball

      - name: Store source tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: source-tarball
          path: axosyslog/dbld/build/*.tar.*
          if-no-files-found: error

  create-packages:
    needs: create-source-tarball
    uses: ./.github/workflows/axosyslog-create-packages.yml
    with:
      source-tarball-artifact-name: source-tarball
      dbld-image-mode: cache
      distros: |
        [
          "almalinux-8"
        ]
