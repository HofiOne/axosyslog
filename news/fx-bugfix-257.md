Fixed race conditions in several functions.

